---
layout: post
title: "OS自作入門日記#1 M1 Macに「ゼロからのOS自作入門」の環境導入"
tags: [OS自作入門, Mac]
excerpt_separator: <!--more-->
---

去年買った「ゼロからのOS自作入門」という本（通称「みかん本」）、ある程度進めてからしばらく放置してしまっていたのですが、最近OSの卒業研究でのxv6やLinuxカーネルのコードリーディングを通して、理解を深めるために再びみかん本の写経をやりたいという欲が出てきました。  
せっかくなので、現在のメイン機であるM1 Macでできるところまでやってみます。手元のUbuntu機にも同様の環境を導入していますが、これについては本に記載されているためここでは省きます。  
完走できるかどうか分かりませんが、忘備録も兼ねて、今日から開発日記ならぬ写経日記的なものを不定期に書いていきたいと思います。

<!--more-->  

なお、あまり本の内容に深入りしてしまうとネタバレ（？）になってしまうので、あくまでも進捗報告や自分なりに工夫した点、感想などを書いていくだけに留まらせていただきます。気になる方は本をご購入ください。  

<html>

  <iframe sandbox="allow-popups allow-scripts allow-modals allow-forms allow-same-origin" style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1&bg1=FFFFFF&fc1=000000&lc1=0000FF&t=&language=ja_JP&o=9&p=8&l=as4&m=amazon&f=ifr&ref=as_ss_li_til&asins=4839975868&linkId=b3dd8858cc48b796494dc37ebf6f16f6">	</iframe>
</html>

# はじめに

みかん本ではUbuntuまたはWSLで進めることが推奨されています。必ずしもM1 Macで本の通りに動くとは限らないので要注意。また、ライブラリ等のバージョンにより動作が大きく異なる場合があります。実験環境を示しておきますのでご参照ください。  
また、1章の部分は以前進めたので飛ばし、いきなり2章から始めさせていただきます。

## 実験環境

- MacBook Air 2020
  - Chip: Apple M1 (arm64)
  - RAM: 8GB
  - Compiler: Homebrew clang version 14.0.6 (CLANGPDB)

## 参考文献

- [Mac で始める「ゼロからのOS自作入門」- Qiita](https://qiita.com/yamoridon/items/4905765cc6e4f320c9b5){:target+"_blank"}

基本的にはこの記事通りに進めております。ただし、最新のClangコンパイラの問題？として、edk2のBaseToolsがビルドできない問題があり、一部のビルドエラーを無視させなければ完遂できませんでした。その手順も追って説明します。

# 手順

## 1. EDK IIの導入

edk2を任意の場所にgit cloneし、submoduleも導入します。  
このとき、現状のmikanosでは最新版のEDK2ではビルドエラーが発生してしまうため、少し古めのバージョンにcheckoutしています（参照：[MikanOSのビルド中にエラー - Issue #19](https://github.com/uchan-nos/mikanos-build/issues/19){:target+"_blank"}）。

```bash
cd ~
git clone https://github.com/tianocore/edk2
cd edk2
git checkout 38c8be123aced4cc8ad5c7e0da9121a181b94251
git submodule init
git submodule update
```


次にEDK IIをビルドするための場所へ移動。

```bash
cd BaseTools/Source/C
```

いざビルド、といきたいところですが、ここで個人的に追加したポイント。このままビルドすると、以下の2つのビルドエラーが発生します。

```
EfiUtilityMsgs.c: In function 'PrintMessage':
EfiUtilityMsgs.c:478:9: error: '__builtin___strncat_chk' output may be truncated copying between 0 and 511 bytes from a string of length 511 [-Werror=stringop-truncation]
  478 |         strncat (Line, Line2, MAX_LINE_LEN - strlen (Line) - 1);
      |         ^~~~~~~
EfiUtilityMsgs.c:463:9: error: '__builtin___strncat_chk' output may be truncated copying between 0 and 511 bytes from a string of length 511 [-Werror=stringop-truncation]
  463 |         strncat (Line, Line2, MAX_LINE_LEN - strlen (Line) - 1);
      |         ^~~~~~~
EfiUtilityMsgs.c:505:5: error: '__builtin___strncat_chk' output may be truncated copying between 0 and 511 bytes from a string of length 511 [-Werror=stringop-truncation]
  505 |     strncat (Line, Line2, MAX_LINE_LEN - strlen (Line) - 1);
      |     ^~~~~~~
```

```
brotli/c/dec/decode.c:2033:41: error: argument 2 of type 'const uint8_t *' {aka 'const unsigned char *'} declared as a pointer [-Werror=vla-parameter]
 2033 |     size_t encoded_size, const uint8_t* encoded_buffer, size_t* decoded_size,
      |                          ~~~~~~~~~~~~~~~^~~~~~~~~~~~~~
In file included from brotli/c/dec/decode.c:7:
./brotli/c/include/brotli/decode.h:204:19: note: previously declared as a variable length array 'const uint8_t[*decoded_size]' {aka 'const unsigned char[*decoded_size]'}
  204 |     const uint8_t encoded_buffer[BROTLI_ARRAY_PARAM(encoded_size)],
      |     ~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
brotli/c/dec/decode.c:2034:14: error: argument 4 of type 'uint8_t *' {aka 'unsigned char *'} declared as a pointer [-Werror=vla-parameter]
 2034 |     uint8_t* decoded_buffer) {
      |     ~~~~~~~~~^~~~~~~~~~~~~~
```

これらのビルドエラーを回避するため、コンパイルオプションを追加しエラーを無視してしまいます。``BaseTools/Source/C/Makefiles``配下の``header.makefile``を開き、  

```
ifeq ($(DARWIN),Darwin)
# assume clang or clang compatible flags on OS X
BUILD_CFLAGS = -MD -fshort-wchar -fno-strict-aliasing -Wall -Werror \
-Wno-deprecated-declarations -Wno-self-assign -Wno-unused-result -nostdlib -g
```

ここに``-Wno-stringop-truncation``と``-Wno-vla-parameter``を追加します。  

```
ifeq ($(DARWIN),Darwin)
# assume clang or clang compatible flags on OS X
BUILD_CFLAGS = -MD -fshort-wchar -fno-strict-aliasing -Wall -Werror \
-Wno-deprecated-declarations -Wno-self-assign -Wno-unused-result -Wno-stringop-truncation -Wno-vla-parameter -nostdlib -g
```

これでOK。ビルドしてみます。

```bash
make
```

最後に``inished building BaseTools C Tools with HOST_ARCH=AARCH64``と表示されたらEDK IIのビルドは完了です。

## 2. mikanos-buildの準備

mikanosのリポジトリを用意します。ビルドと実行用のツールがここに含まれます。

```bash
cd ~
git clone https://github.com/uchan-nos/mikanos-build.git osbook
```

そして、  

```bash
cd osbook/devenv
curl -L https://github.com/uchan-nos/mikanos-build/releases/download/v2.0/x86_64-elf.tar.gz | tar xz
cd ../
```


次にmikanos-buildの各ファイルをMac用に書き換える必要がありますが、ここでMac用のパッチファイルmac.patchを生成します。パッチファイルを生成してくださった方がいらっしゃいますので、今回はこれを使わせていただきます。[Qiitaに記載されているもの](https://qiita.com/yamoridon/items/4905765cc6e4f320c9b5#mikanos-build-%E3%83%AA%E3%83%9D%E3%82%B8%E3%83%88%E3%83%AA%E3%81%AE%E6%BA%96%E5%82%99){:target+"_blank"}をコピペして``~/osbook/``に生成します。  
このとき、マウス操作でコピペするとpatchファイルの空白等がうまくコピペできず正常に動作しない場合があり、Qiitaのコピペボタンでコピペすることをオススメします。  

mac.patchを生成したら、以下のコマンドによって各ファイルにパッチを適用することでMac用にmikanos-buildの各ファイルが書き換えられます。  

```bash
patch -p1 < mac.patch
```



## 3. 環境の準備

qemu、llvm、nasmといった必要な環境をインストールしてパスを通す。

```bash
brew install qemu
brew install llvm
export PATH=/opt/homebrew/opt/llvm/bin:$PATH
brew install nasm dosfstools binutils
export PATH=/opt/homebrew/sbin:/opt/homebrew/opt/binutils/bin:$PATH
```

## 4. ワークスペースの準備

主にOSのファイルを置いておく場所を用意します。

```bash
cd ~
mkdir workspace
cd workspace
git clone https://github.com/uchan-nos/mikanos.git
cd mikanos
```

今回はosbook_day02aにcheckoutして使います。  

```bash
git checkout osbook_day02a
```

## 5. シンボリックリンクの生成

edk2にmikanosのworkspaceにある``MikanLoaderPkg``へのシンボリックリンクを生成しておきます。そして、``edksetup.sh``をsourceで読み込みます。

```bash
cd ~/edk2
ln -s ~/workspace/mikanos/MikanLoaderPkg ./
source edksetup.sh
```

これによりConf/配下に``target.txt``と``tools_def.txt``が生成されます。

## 6. Conf/target.txtの設定

以下の箇所を書き換えます。  

- ACTIVE_PLATFORM
  - EmulatorPkg/EmulatorPkg.dsc → MikanLoaderPkg/MikanLoaderPkg.dsc
- TARGET_ARCH
  - IA32 → X64
- TOOL_CHAIN_TAG
  - VS2015x86 → CLANGPDB



```
︙
ACTIVE_PLATFORM       = MikanLoaderPkg/MikanLoaderPkg.dsc
︙
TARGET                = DEBUG
︙
TARGET_ARCH           = X64
︙
TOOL_CHAIN_TAG        = CLANGPDB
︙
```

## 7. ビルド＆実行！

ようやっと準備が整いました。``edk2``にてbuildを実行。  

```bash
build
```

最後に

```
- Done -
Build end time: 04:01:25, Aug.12 2022
Build total time: 00:00:06
```

こんな感じのが出てきたらビルド成功です。``~/edk2/Build/MikanLoaderX64/DEBUG_CLANGPDB/X64/Loader.efi``というファイルが生成されているはずです。  

最後にQEMUで実行します。  

```bash
~/osbook/devenv/run_qemu.sh ~/edk2/Build/MikanLoaderX64/DEBUG_CLANGPDB/X64/Loader.efi
```


![スクリーンショット 2022-08-12 8.53.06](../../../assets/img/post/2022-8-19/スクリーンショット 2022-08-12 8.53.06.png)  
できた！

### 補足

おま環あるいは偶然かもしれませんが、mac.patchを適用したとき、``~/osbook/devenv/``の``mount_image.sh``にて

```sh
#!/bin/sh -ex

if [ $# -lt 2 ]
then
    echo "Usage: $0 <image name> <mount point>"
    exit 1
fi

DEVENV_DIR=$(dirname "$0")
DISK_IMG=$1
MOUNT_POINT=$2

if [ ! -f $DISK_IMG ]
then
    echo "No such file: $DISK_IMG"
    exit 1
fi

if [ `uname` = 'Darwin' ]; then
    hdiutil attach -mountpoint $MOUNT_POINT $DISK_IMG
else
    mkdir -p $MOUNT_POINT
    sudo mount -o loop $DISK_IMG $MOUNT_POINT
fi
```

の最終行の``fi``が抜けていたので手動で付け足しておきました。うーん、なぜここだけ抜けたか謎です。

